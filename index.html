<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Brother Trans 2026</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap');
        body { font-family: 'Plus Jakarta Sans', sans-serif; }
        .custom-scroll::-webkit-scrollbar { width: 4px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #e2e8f0; border-radius: 10px; }
    </style>
</head>
<body class="bg-gray-50 text-slate-900 min-h-screen pb-20">

    <header class="bg-slate-900 text-white p-6 shadow-2xl sticky top-0 z-50">
        <div class="container mx-auto flex flex-col lg:flex-row justify-between items-center gap-6">
            <div class="flex items-center space-x-4">
                <div class="bg-yellow-400 p-3 rounded-2xl shadow-lg shadow-yellow-400/20 transform -rotate-6">
                    <i class="fas fa-desktop text-slate-900 text-2xl"></i>
                </div>
                <div>
                    <h1 class="text-2xl font-black italic tracking-tighter uppercase leading-none">Brothers <span class="text-yellow-400">trans</span></h1>
                    <p class="text-[9px] font-bold text-slate-500 tracking-[0.4em] uppercase mt-1">Integrated Control Center</p>
                </div>
            </div>

            <nav class="flex flex-wrap justify-center gap-2">
                <a href="cashier.html" class="bg-green-600 hover:bg-green-500 text-white px-5 py-3 rounded-2xl text-[10px] font-black transition flex items-center shadow-lg">KASIR POS</a>
                <a href="inventory.html" class="bg-slate-800 text-white px-5 py-3 rounded-2xl text-[10px] font-bold transition flex items-center">GUDANG</a>
                <a href="manage-units.html" class="bg-slate-800 text-white px-5 py-3 rounded-2xl text-[10px] font-bold transition flex items-center">ARMADA</a>
            </nav>
        </div>
    </header>

    <main class="container mx-auto p-4 md:p-8">
        
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-12">
            <div class="bg-slate-900 p-8 rounded-[3rem] shadow-2xl relative overflow-hidden group">
                <p class="text-[10px] text-slate-400 font-black uppercase tracking-widest mb-1">Profit Riil (Lunas)</p>
                <p id="stat-profit" class="text-3xl font-black text-yellow-400 tracking-tighter relative z-10">Rp 0</p>
                <i class="fas fa-wallet absolute right-[-10px] bottom-[-10px] text-8xl text-white/5 rotate-12 transition group-hover:scale-110"></i>
            </div>
            <div class="bg-white p-8 rounded-[3rem] shadow-sm border border-gray-100 border-l-8 border-l-red-500">
                <p class="text-[10px] text-gray-400 font-black uppercase tracking-widest mb-1">Piutang (Billing)</p>
                <p id="stat-unpaid" class="text-2xl font-black text-slate-800">Rp 0</p>
            </div>
            <div class="bg-white p-8 rounded-[3rem] shadow-sm border border-gray-100 border-l-8 border-l-orange-400">
                <p class="text-[10px] text-gray-400 font-black uppercase tracking-widest mb-1">Stok Kritis (< 5)</p>
                <p id="stat-low-stock" class="text-2xl font-black text-orange-500">0 Item</p>
            </div>
            <a href="form-service.html" class="bg-yellow-400 p-8 rounded-[3rem] shadow-xl flex items-center justify-between group hover:bg-slate-900 transition duration-500">
                <p class="text-xs font-black text-slate-900 group-hover:text-white uppercase tracking-widest leading-tight">Input<br>Log Servis</p>
                <i class="fas fa-plus-circle text-3xl text-slate-900 opacity-20 group-hover:text-yellow-400 group-hover:opacity-100 transition"></i>
            </a>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
            
            <div class="lg:col-span-4">
                <div class="bg-white rounded-[3rem] shadow-sm border border-gray-100 overflow-hidden h-full">
                    <div class="p-8 border-b border-gray-50 bg-gray-50/50 flex justify-between items-center">
                        <h3 class="font-black text-slate-800 text-[10px] uppercase tracking-[0.3em]">Kasir Terbaru</h3>
                        <a href="cashier.html" class="text-[9px] font-black text-blue-500 hover:underline">DETAIL</a>
                    </div>
                    <div class="p-2">
                        <table class="w-full text-left">
                            <tbody id="recent-transactions" class="divide-y divide-gray-50 text-sm font-medium"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="lg:col-span-4">
                <div class="bg-white rounded-[3rem] shadow-sm border border-gray-100 overflow-hidden h-full">
                    <div class="p-8 border-b border-gray-50 bg-gray-50/50">
                        <h3 class="font-black text-slate-800 text-[10px] uppercase tracking-[0.3em]">Status Gudang</h3>
                    </div>
                    <div id="inventory-list" class="p-6 space-y-4 custom-scroll overflow-y-auto max-h-[450px]">
                        </div>
                </div>
            </div>

            <div class="lg:col-span-4">
                <div class="bg-white rounded-[3rem] shadow-sm border border-gray-100 overflow-hidden h-full">
                    <div class="p-8 border-b border-gray-50 bg-gray-50/50">
                        <h3 class="font-black text-slate-800 text-[10px] uppercase tracking-[0.3em]">Servis Terakhir</h3>
                    </div>
                    <div id="service-logs" class="p-6 space-y-4 custom-scroll overflow-y-auto max-h-[450px]">
                        </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        const formatR = (n) => new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(n);

        async function refreshDashboard() {
            try {
                const [resT, resU, resS, resP] = await Promise.all([
                    fetch('/api/transactions'),
                    fetch('/api/units'),
                    fetch('/api/services'),
                    fetch('/api/parts')
                ]);

                const transactions = await resT.json();
                const units = await resU.json();
                const services = await resS.json();
                const parts = await resP.json();

                // 1. HITUNG STATS KASIR (Lunas vs Piutang)
                const paidIncome = transactions.filter(t => t.type === 'INCOME' && t.status === 'PAID').reduce((a, b) => a + b.amount, 0);
                const unpaidIncome = transactions.filter(t => t.type === 'INCOME' && t.status === 'UNPAID').reduce((a, b) => a + b.amount, 0);
                const totalExpense = transactions.filter(t => t.type === 'EXPENSE').reduce((a, b) => a + b.amount, 0);
                const lowStockCount = parts.filter(p => p.stock < 5).length;

                document.getElementById('stat-profit').innerText = formatR(paidIncome - totalExpense);
                document.getElementById('stat-unpaid').innerText = formatR(unpaidIncome);
                document.getElementById('stat-low-stock').innerText = `${lowStockCount} Item`;

                // 2. RENDER KASIR FEED
                const tBody = document.getElementById('recent-transactions');
                tBody.innerHTML = '';
                transactions.reverse().slice(0, 6).forEach(t => {
                    const isInc = t.type === 'INCOME';
                    tBody.innerHTML += `
                        <tr class="hover:bg-gray-50 transition border-b border-gray-50 last:border-0">
                            <td class="p-4">
                                <div class="font-black text-slate-700 text-[9px] uppercase tracking-tighter">${t.category}</div>
                                <div class="text-[8px] font-bold text-gray-300 uppercase">${new Date(t.date || t.id).toLocaleDateString('id-ID', {day:'2-digit', month:'short'})}</div>
                            </td>
                            <td class="p-4 text-right">
                                <div class="font-black text-[10px] ${isInc ? 'text-green-600' : 'text-slate-400'}">${isInc ? '+' : '-'} ${t.amount.toLocaleString()}</div>
                                <div class="text-[7px] font-black uppercase ${t.status === 'PAID' ? 'text-blue-400' : 'text-red-400'}">${t.status}</div>
                            </td>
                        </tr>
                    `;
                });

                // 3. RENDER GUDANG (Prioritas Stok Rendah)
                const pBody = document.getElementById('inventory-list');
                pBody.innerHTML = '';
                parts.sort((a,b) => a.stock - b.stock).slice(0, 8).forEach(p => {
                    const isLow = p.stock < 5;
                    pBody.innerHTML += `
                        <div class="flex items-center justify-between p-4 bg-gray-50 rounded-2xl border ${isLow ? 'border-orange-100 animate-pulse' : 'border-gray-100'}">
                            <div class="text-[10px] font-black text-slate-700 uppercase tracking-tighter">${p.name}</div>
                            <div class="text-[10px] font-black ${isLow ? 'text-orange-500' : 'text-slate-400'}">${p.stock} Pcs</div>
                        </div>
                    `;
                });

                // 4. RENDER REKAM MEDIS
                const sBody = document.getElementById('service-logs');
                sBody.innerHTML = '';
                services.reverse().slice(0, 6).forEach(s => {
                    sBody.innerHTML += `
                        <div onclick="window.location.href='unit-detail.html?plate=${s.plateNumber}'" class="p-4 bg-white border border-gray-100 rounded-2xl flex justify-between items-center group hover:bg-slate-900 transition duration-300 cursor-pointer shadow-sm">
                            <div>
                                <div class="text-[10px] font-black uppercase group-hover:text-yellow-400">${s.plateNumber}</div>
                                <div class="text-[8px] font-bold text-gray-400 group-hover:text-slate-500 uppercase">${s.workshopName}</div>
                            </div>
                            <i class="fas fa-chevron-right text-[10px] text-gray-200 group-hover:text-white"></i>
                        </div>
                    `;
                });

            } catch (err) { console.error("Sinkronisasi Dashboard Gagal:", err); }
        }

        window.onload = refreshDashboard;
    </script>
</body>
</html>